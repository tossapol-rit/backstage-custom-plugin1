{% if values.database != 'none' %}
import { Injectable } from '@angular/core';
import { ConfigService, DatabaseConfig } from './config.service';
{% if values.database == 'postgresql' %}
import { Pool } from 'pg';
{% elif values.database == 'mysql' %}
import * as mysql from 'mysql2/promise';
{% elif values.database == 'mongodb' %}
import { MongoClient } from 'mongodb';
{% endif %}

@Injectable({
  providedIn: 'root'
})
export class DatabaseService {
{% if values.database == 'postgresql' %}
  private pool: Pool | null = null;

  constructor(private configService: ConfigService) {}

  private async getPool(): Promise<Pool> {
    if (!this.pool) {
      const dbConfig = this.configService.getDatabaseConfig();
      
      if (!dbConfig) {
        throw new Error('Database configuration not loaded');
      }

      this.pool = new Pool({
        host: dbConfig.host,
        port: dbConfig.port,
        database: dbConfig.database,
        user: dbConfig.username,
        password: dbConfig.password,
        ssl: dbConfig.ssl ? { rejectUnauthorized: true } : false,
        max: 20,
        idleTimeoutMillis: 30000,
        connectionTimeoutMillis: 2000,
      });

      console.log(`PostgreSQL pool created for ${dbConfig.host}:${dbConfig.port}/${dbConfig.database}`);
    }
    
    return this.pool;
  }

  async query(text: string, params?: any[]) {
    const pool = await this.getPool();
    const client = await pool.connect();
    try {
      const result = await client.query(text, params);
      return result.rows;
    } finally {
      client.release();
    }
  }

  async close() {
    if (this.pool) {
      await this.pool.end();
      this.pool = null;
    }
  }

  async healthCheck(): Promise<boolean> {
    try {
      await this.query('SELECT 1');
      return true;
    } catch (error) {
      console.error('Database health check failed:', error);
      return false;
    }
  }
{% elif values.database == 'mysql' %}
  private pool: mysql.Pool | null = null;

  constructor(private configService: ConfigService) {}

  private async getPool(): Promise<mysql.Pool> {
    if (!this.pool) {
      const dbConfig = this.configService.getDatabaseConfig();
      
      if (!dbConfig) {
        throw new Error('Database configuration not loaded');
      }

      this.pool = mysql.createPool({
        host: dbConfig.host,
        port: dbConfig.port,
        database: dbConfig.database,
        user: dbConfig.username,
        password: dbConfig.password,
        ssl: dbConfig.ssl ? {} : undefined,
        waitForConnections: true,
        connectionLimit: 10,
        queueLimit: 0
      });

      console.log(`MySQL pool created for ${dbConfig.host}:${dbConfig.port}/${dbConfig.database}`);
    }
    
    return this.pool;
  }

  async query(sql: string, values?: any[]) {
    const pool = await this.getPool();
    const [rows] = await pool.execute(sql, values);
    return rows;
  }

  async close() {
    if (this.pool) {
      await this.pool.end();
      this.pool = null;
    }
  }

  async healthCheck(): Promise<boolean> {
    try {
      await this.query('SELECT 1');
      return true;
    } catch (error) {
      console.error('Database health check failed:', error);
      return false;
    }
  }
{% elif values.database == 'mongodb' %}
  private client: MongoClient | null = null;
  private dbName: string = '';

  constructor(private configService: ConfigService) {}

  private async getClient(): Promise<MongoClient> {
    if (!this.client) {
      const dbConfig = this.configService.getDatabaseConfig();
      
      if (!dbConfig) {
        throw new Error('Database configuration not loaded');
      }

      // Build MongoDB connection string
      const auth = dbConfig.username && dbConfig.password 
        ? `${dbConfig.username}:${dbConfig.password}@` 
        : '';
      const sslParam = dbConfig.ssl ? '?ssl=true' : '';
      const uri = `mongodb://${auth}${dbConfig.host}:${dbConfig.port}${sslParam}`;
      
      this.dbName = dbConfig.database;
      this.client = new MongoClient(uri);
      
      await this.client.connect();
      console.log(`MongoDB connected to ${dbConfig.host}:${dbConfig.port}/${dbConfig.database}`);
    }
    
    return this.client;
  }

  async connect() {
    const client = await this.getClient();
    return client.db(this.dbName);
  }

  async close() {
    if (this.client) {
      await this.client.close();
      this.client = null;
    }
  }

  async getCollection(collectionName: string) {
    const client = await this.getClient();
    return client.db(this.dbName).collection(collectionName);
  }

  async healthCheck(): Promise<boolean> {
    try {
      const client = await this.getClient();
      await client.db(this.dbName).admin().ping();
      return true;
    } catch (error) {
      console.error('Database health check failed:', error);
      return false;
    }
  }
{% endif %}
}
{% endif %}
